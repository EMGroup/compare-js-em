<html>
<head>
	<link rel="stylesheet" type="text/css" href="node_modules/@construit/highlighter/css/construit-highlighter.css">
	<link rel="stylesheet" type="text/css" href="node_modules/@construit/scriptbox/css/interpreter.css">
	<link rel="stylesheet" type="text/css" href="node_modules/@construit/scriptbox/css/gutter.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
	<script src="node_modules/@construit/scriptbox/construit-scriptbox.min.js"></script>
	<script src="node_modules/@construit/runtime/construit-runtime.min.js"></script>
	<script src="node_modules/esprima/dist/esprima.js"></script>
	<script src="https://use.fontawesome.com/f172de12fc.js"></script>

	<style>
		body {
			display: flex;
			font-size: 20px;
			font-family: "Roboto", Helvetica, arial;
			flex-direction: column;
			margin: 0;
		}

		#menu {
			background: #eee;
			padding: 15px;
			display: flex;
			color: #666;
		}

		#emmenu {
			width: 50%;
			text-align: center;
		}

		#emmenu > select {
			margin-top: 5px;
		}

		#jsmenu {
			width: 50%;
			text-align: center;
		}

		#jsmenu > select {
			margin-top: 5px;
		}

		#inputs {
			display: flex;
			background: #777;
			overflow: hidden;
		}

		#emtextin {
			width: 50%;
			margin: 20px;
			font-size: 20px;
			box-sizing: border-box;
			overflow: auto;
			box-shadow: 0 0 10px black;
			background: #f3f0da;
		}

		#jstextin {
			width: 50%;
			margin: 20px;
			font-size: 20px;
			box-sizing: border-box;
			overflow: auto;
			box-shadow: 0 0 10px black;
			background: #f3f0da;
		}

	</style>
</head>
<body>
	<script>
		function ajax(options) {
			var xhr = new XMLHttpRequest();
			//xhr.withCredentials = true;
			xhr.open(options.type.toUpperCase(), options.url);
			//xhr.setRequestHeader('Content-Type', 'application/json');
			xhr.onload = function() {
				if (xhr.status === 200 || xhr.status == 0) {
					var data;
					if (xhr.responseText.charAt(0) == "{" || xhr.responseText.charAt(0) == "[") data = JSON.parse(xhr.responseText);
					else data = xhr.responseText;
					options.success(data);
				} else {
					options.error(xhr, xhr.status, xhr.responseText);
				}
			};
			xhr.send((options.data) ? JSON.stringify(options.data) : undefined);
		}

		function jsparser(src) {
			var errors = [];
			var ast;

			// Filter out markdown comments
			src = src.split("\n").map(function(x) {
				if (x.startsWith("#")) return "";
				else return x;
			}); //.join("\n");

			var lines = [];
			lines[0] = 0;
			for (var i=1; i<src.length; i++) {
				lines[i] = lines[i-1] + src[i-1].length + 1;
			}
			var curline = 0;

			src = src.join("\n");
			
			var statements = {};

			try {
				ast = esprima.parse(src, {range: true});
				//console.log(ast);

				for (var i=0; i<ast.body.length; i++) {
					while (lines.length > curline+1 && ast.body[i].range[0] >= lines[curline+1]) {
						curline++;
					}
					statements[curline] = ast.body[i];
					ast.body[i].source = src.substr(ast.body[i].range[0], ast.body[i].range[1]);
				}

				console.log(statements);

			} catch(e) {
				console.log(e);
				errors.push(e);
				e.line = e.lineNumber;
				e.messageText = function() { return e.description; };
			}
			return {
				ast: ast,
				errors: errors,
				hasErrors: function() { return (errors.length > 0); },
				getError: function() { return errors[0]; },
				source: src,
				statements: [],
				getStatementByLine: function(line) { return statements[line]; }
			}
		}
		function jstranslator(ast) {
			eval(ast.source);
		}
		window.onload = function() {
			var input = document.getElementById("emtextin");
			var inputjs = document.getElementById("jstextin");

			rt = new Construit.runtime.RunTime();
			var embox = new Construit.ScriptBox(input, rt);

			var jsbox = new Construit.ScriptBox(inputjs, rt, {
				parser: {parse: jsparser},
				translator: { eval: jstranslator },
				keywords: {
					"do": "do",
					"if": "if",
					"in": "in",
					"for": "for",
					"let": "let",
					"new": "new",
					"try": "try",
					"var": "var",
					"case": "case",
					"else": "else",
					"enum": "enum",
					"this": "this",
					"with": "with",
					"await": "await",
					"break": "break",
					"catch": "catch",
					"class": "class",
					"const": "const",
					"super": "super",
					"throw": "throw",
					"while": "while",
					"yield": "yield",
					"delete": "delete",
					"export": "export",
					"import": "import",
					"public": "public",
					"return": "return",
					"static": "static",
					"switch": "switch",
					"typeof": "typeof",
					"default": "default",
					"extends": "extends",
					"finally": "finally",
					"package": "package",
					"private": "private",
					"continue": "continue",
					"debugger": "debugger",
					"function": "function",
					"interface": "interface",
					"protected": "protected",
					"prototype": "prototype",
					"implements": "implements",
					"instanceof": "instanceof"
				}
			});

			var jsoptions = document.getElementById("jsoptions");
			jsoptions.onchange = function(e) {
				ajax({
					url: jsoptions.value,
					type: "get",
					success: function(data){
						jsbox.intextarea.value = data;
						jsbox.updateEntireHighlight();
					},
					error: function(a){
						
					}
				});
			}
			jsoptions.onchange();

			var emoptions = document.getElementById("emoptions");
			emoptions.onchange = function(e) {
				ajax({
					url: emoptions.value,
					type: "get",
					success: function(data){
						embox.intextarea.value = data;
						embox.updateEntireHighlight();
					},
					error: function(a){
						
					}
				});
			}
			emoptions.onchange();
		}
	</script>

	<div id="menu">
		<div id="emmenu"><b>ConstruitScript</b><br>
			<select id="emoptions">
			<option value="scripts/house/step1.js-e">House - Initial Script</option>
			<option value="scripts/house/step1a.js-e">House - Monolithic Definition</option>
			</select>
		</div>
		<div id="jsmenu"><b>JavaScript</b><br>
			<select id="jsoptions">
			<option value="scripts/house/step1.js">House - Single Function</option>
			<option value="scripts/house/step1b.js">House - Naive OO</option>
			<option value="scripts/house/step1c.js">House - OO Refactor Roof</option>
			<option value="scripts/house/step1d.js">House - OO Refactor All Locals</option>
			<option value="scripts/house/step1e.js">House - OO Refactor Floors</option>
			<option value="scripts/house/step1f.js">House - OO Refactor Computed Members</option>
			<option value="scripts/house/step1g.js">House - OO Inject Triangle</option>
			<option value="scripts/house/step1h.js">House - OO Dependency Injection</option> 
			</select>
		</div>
	</div>
	<div id="inputs">
		<div id="emtextin"></div>
		<div id="jstextin"></div>
	</div>
</body>
</html>

